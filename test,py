import numpy as np
from PIL import Image, ImageDraw, ImageFont
import warnings
import json
import os

warnings.filterwarnings('ignore')

# --- Import PaddleOCR ---
from paddleocr import PaddleOCR
from deep_translator import GoogleTranslator

# --- C·∫•u h√¨nh ---
INPUT_IMAGE_PATH = "video/images/original/frame_001832.jpg"
OUTPUT_IMAGE_PATH = "output/translated_frame_argos_v2.jpg"

FROM_CODE = "de"
TO_CODE = "en"


# --------------------------------------------------------
# 1. Kh·ªüi t·∫°o PaddleOCR
# --------------------------------------------------------
def initialize_ocr():
    print("1. Kh·ªüi t·∫°o PaddleOCR...")
    ocr = PaddleOCR(
        use_doc_orientation_classify=False,
        use_doc_unwarping=False,
        use_textline_orientation=False,
        lang='german'
    )
    return ocr


# --------------------------------------------------------
# 2. API d·ªãch vƒÉn b·∫£n
# --------------------------------------------------------
def translate_text(text_list):
    if not text_list:
        return []

    translator = GoogleTranslator(source='de', target='en')
    translated_texts = []

    for text in text_list:
        try:
            # B·ªè qua text r·ªóng
            if not text or not text.strip():
                translated_texts.append(text)
                print(f"  ‚äó B·ªè qua text r·ªóng")
                continue

            translated = translator.translate(text)

            # Ki·ªÉm tra k·∫øt qu·∫£ d·ªãch
            if translated is None or not translated.strip():
                print(f"  ‚ö† '{text}' ‚Üí (gi·ªØ nguy√™n - d·ªãch th·∫•t b·∫°i)")
                translated_texts.append(text)
            else:
                translated_texts.append(translated)
                print(f"  ‚úì '{text}' ‚Üí '{translated}'")

        except Exception as e:
            print(f"  ‚úó L·ªói d·ªãch '{text}': {e}")
            translated_texts.append(text)  # Gi·ªØ nguy√™n text g·ªëc n·∫øu l·ªói

    return translated_texts


# --------------------------------------------------------
# 3. V·∫Ω text ƒë√£ d·ªãch v√†o bounding box
# --------------------------------------------------------
# --------------------------------------------------------
# 3. V·∫Ω text ƒë√£ d·ªãch v√†o bounding box
# --------------------------------------------------------
def draw_translated_text(image_path, results):
    print("\n4. ƒêang ch√®n text ƒë√£ d·ªãch v√†o ·∫£nh...")

    img = Image.open(image_path).convert("RGB")
    draw = ImageDraw.Draw(img)

    try:
        default_font = ImageFont.truetype(
            "/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf", 32)  # Bold ƒë·ªÉ r√µ h∆°n
    except:
        try:
            default_font = ImageFont.truetype(
                "/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf", 32)
        except:
            default_font = ImageFont.load_default()

    for item in results:
        box = item['box']
        translated = item['translated_text']

        # CRITICAL FIX: Ki·ªÉm tra translated kh√¥ng ph·∫£i None ho·∫∑c r·ªóng
        if translated is None or not str(translated).strip():
            print(f"  ‚ö† B·ªè qua v·∫Ω text r·ªóng t·∫°i box {box}")
            continue

        # ƒê·∫£m b·∫£o translated l√† string
        translated = str(translated).strip()

        # box c√≥ th·ªÉ l√† rec_polys (4 points) ho·∫∑c rec_boxes (x1,y1,x2,y2)
        if len(box) == 4 and isinstance(box[0], (list, tuple, np.ndarray)):
            # Tr∆∞·ªùng h·ª£p rec_polys: [[x1,y1], [x2,y2], [x3,y3], [x4,y4]]
            x_coords = [p[0] for p in box]
            y_coords = [p[1] for p in box]
            x_min = int(min(x_coords))
            y_min = int(min(y_coords))
            x_max = int(max(x_coords))
            y_max = int(max(y_coords))
        else:
            # Tr∆∞·ªùng h·ª£p rec_boxes: [x1, y1, x2, y2]
            x_min, y_min, x_max, y_max = map(int, box)

        height = y_max - y_min
        width = x_max - x_min

        # B·ªè qua box qu√° nh·ªè
        if height < 5 or width < 5:
            print(f"  ‚ö† B·ªè qua box qu√° nh·ªè: {width}x{height}")
            continue

        # X√≥a text c≈© - ƒê·ªîI SANG N·ªÄN TR·∫ÆNG
        draw.rectangle([(x_min, y_min), (x_max, y_max)], fill="white")

        # Font size ƒë·ªông - TƒÇNG C·ª† CH·ªÆ (t·ª´ 0.6 l√™n 0.8)
        font_size = max(14, int(height * 0.8))  # TƒÉng t·ª´ 0.6 l√™n 0.8

        try:
            # D√πng font Bold ƒë·ªÉ r√µ h∆°n
            font = ImageFont.truetype(
                "/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf", font_size)
        except:
            try:
                font = ImageFont.truetype(
                    "/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf", font_size)
            except:
                font = default_font

        # Canh text theo chi·ªÅu d·ªçc (center vertical)
        text_y = y_min + (height - font_size) // 2

        # V·∫Ω text m√†u ƒêEN tr√™n n·ªÅn TR·∫ÆNG
        try:
            draw.text((x_min + 2, text_y), translated, fill="black", font=font)
        except Exception as e:
            print(f"  ‚úó L·ªói v·∫Ω text '{translated}': {e}")

    img.save(OUTPUT_IMAGE_PATH)
    print(f"\n‚úì ·∫¢nh ƒë√£ l∆∞u t·∫°i: {OUTPUT_IMAGE_PATH}")


# --------------------------------------------------------
# MAIN
# --------------------------------------------------------
def main():
    print("=" * 50)
    print("B·∫ÆT ƒê·∫¶U D·ªäCH ·∫¢NH")
    print("=" * 50)

    ocr = initialize_ocr()
    print(f"\n2. OCR ·∫£nh: {INPUT_IMAGE_PATH}")

    # ---- CH·∫†Y OCR v·ªõi predict() ----
    result = ocr.predict(INPUT_IMAGE_PATH)

    if not result:
        print("‚úó Kh√¥ng t√¨m th·∫•y text.")
        return

    # ---- TR√çCH XU·∫§T TEXT & BOX t·ª´ result ----
    print("\nüìù Tr√≠ch xu·∫•t d·ªØ li·ªáu OCR...")

    if not isinstance(result, list) or len(result) == 0:
        print("‚úó Result kh√¥ng h·ª£p l·ªá")
        return

    # L∆∞u k·∫øt qu·∫£ OCR ra file
    for res in result:
        res.print()
        res.save_to_img("output")
        res.save_to_json("output")

    # ƒê·ªçc l·∫°i t·ª´ JSON
    json_filename = f'output/{os.path.basename(INPUT_IMAGE_PATH).replace(".jpg", "_res.json")}'

    if not os.path.exists(json_filename):
        print(f"‚úó Kh√¥ng t√¨m th·∫•y file JSON: {json_filename}")
        return

    with open(json_filename, 'r', encoding='utf-8') as f:
        data = json.load(f)

    rec_texts = data['rec_texts']
    rec_scores = data['rec_scores']
    rec_boxes = data['rec_boxes']

    print(f"üîç T√¨m th·∫•y {len(rec_texts)} ƒëo·∫°n text trong ·∫£nh")

    # ---- TR√çCH XU·∫§T TEXT & BOX ----
    print("\nüìù VƒÉn b·∫£n t√¨m ƒë∆∞·ª£c:")
    detected_boxes = []
    original_texts = []

    for i in range(len(rec_texts)):
        text = rec_texts[i]
        score = float(rec_scores[i])
        box = rec_boxes[i]  # [x1, y1, x2, y2]

        # B·ªè qua text r·ªóng ho·∫∑c score th·∫•p
        if not text or not str(text).strip() or score < 0.25:
            print(f"  ‚äó B·ªè qua: '{text}' (score {score:.2f})")
            continue

        print(f"  [{i}] '{text}' (score {score:.2f})")

        detected_boxes.append({
            "box": box,  # [x1, y1, x2, y2]
            "original_text": text,
            "confidence": score
        })
        original_texts.append(text)

    print(f"\n‚Üí T·ªïng c·ªông {len(original_texts)} ƒëo·∫°n text h·ª£p l·ªá")

    if not original_texts:
        print("‚úó Kh√¥ng c√≥ text n√†o ƒë·ªß ƒëi·ªÅu ki·ªán ƒë·ªÉ d·ªãch.")
        return

    # ---- D·ªäCH ----
    print("\n3. ƒêang d·ªãch...")
    translated_texts = translate_text(original_texts)

    # Gh√©p l·∫°i theo c√πng index
    final_results = []
    for i, item in enumerate(detected_boxes):
        item["translated_text"] = translated_texts[i]
        final_results.append(item)

    print("\nüìã K·∫øt qu·∫£ cu·ªëi:")
    for f in final_results:
        orig = f['original_text']
        trans = f['translated_text']
        print(f"  '{orig}' ‚Üí '{trans}'")

    # ---- V·∫º L√äN ·∫¢NH ----
    draw_translated_text(INPUT_IMAGE_PATH, final_results)

    print("\n" + "=" * 50)
    print("HO√ÄN T·∫§T!")
    print("=" * 50)


if __name__ == "__main__":
    main()